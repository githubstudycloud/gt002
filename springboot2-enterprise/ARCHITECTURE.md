# 系统架构设计

## 整体架构

本项目采用微服务架构，基于 Spring Boot 2.x + Spring Cloud Alibaba 构建，实现了从开发到生产部署的完整技术链路。

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户/客户端层                              │
│                    (Web/Mobile/Third-party)                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                         网关层 (Gateway)                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  负载均衡 │ 路由转发 │ 认证鉴权 │ 限流熔断 │ 日志记录    │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  用户服务      │ │  订单服务      │ │  商品服务      │
│              │ │              │ │              │
│  - 用户管理    │ │  - 订单管理    │ │  - 商品管理    │
│  - 认证授权    │ │  - 支付对接    │ │  - 库存管理    │
│  - 权限控制    │ │  - 物流跟踪    │ │  - 分类管理    │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  服务治理层    │ │   数据存储层   │ │   消息队列    │
│              │ │              │ │              │
│  • Nacos     │ │  • MySQL     │ │  • RocketMQ  │
│  • Sentinel  │ │  • Redis     │ │  • Kafka     │
│  • Feign     │ │  • ES        │ │              │
└──────────────┘ └──────────────┘ └──────────────┘
```

## 技术架构分层

### 1. 客户端层
- **Web 前端**: Vue.js / React
- **移动端**: Flutter / React Native
- **第三方集成**: RESTful API / SDK

### 2. 网关层
- **API Gateway**: Spring Cloud Gateway
- **功能**:
  - 路由转发
  - 统一认证鉴权 (Sa-Token)
  - 限流熔断 (Sentinel)
  - 日志记录
  - 协议转换
  - API 文档聚合

### 3. 业务服务层
- **用户服务** (User Service)
  - 用户注册、登录
  - 用户信息管理
  - 权限控制

- **订单服务** (Order Service)
  - 订单创建、查询
  - 订单状态流转
  - 支付集成

- **商品服务** (Product Service)
  - 商品管理
  - 库存管理
  - 分类管理

### 4. 公共服务层
- **通知服务**: 短信、邮件、站内信
- **文件服务**: 文件上传、存储、访问
- **定时任务**: XXL-Job / Elastic-Job

### 5. 基础设施层

#### 服务治理
- **Nacos**: 服务注册与发现、配置管理
- **Sentinel**: 流量控制、熔断降级
- **OpenFeign**: 服务间调用
- **LoadBalancer**: 客户端负载均衡

#### 数据存储
- **MySQL 8.0**: 业务数据存储
  - 主从复制
  - 读写分离
  - 分库分表 (ShardingSphere)

- **Redis 7.0**: 缓存、分布式锁
  - 多级缓存
  - 热点数据缓存
  - Session 共享

- **Elasticsearch**: 日志存储、全文搜索
  - 日志聚合
  - 业务搜索

#### 消息队列
- **RocketMQ**: 业务消息
  - 异步解耦
  - 流量削峰
  - 事务消息

- **Kafka**: 日志、事件流
  - 日志收集
  - 实时数据流

### 6. 监控运维层

#### 监控系统
- **Prometheus**: 指标采集
- **Grafana**: 可视化监控
- **Alertmanager**: 告警通知

#### 日志系统
- **ELK Stack**:
  - Elasticsearch: 存储
  - Logstash: 处理
  - Kibana: 可视化

#### 链路追踪
- **Zipkin**: 分布式链路追踪
- **SkyWalking**: APM 性能监控

## 数据流架构

### 同步调用流程
```
Client → Gateway → Service A → Service B → Database
                       ↓
                    Redis Cache
```

### 异步消息流程
```
Service A → RocketMQ → Service B → Database
              ↓
         Dead Letter Queue
```

### 日志收集流程
```
Application → Logstash → Elasticsearch → Kibana
     ↓
  Local File
```

## 部署架构

### Docker Compose 部署（开发/测试环境）

```
┌─────────────────────────────────────────────┐
│              Docker Host                    │
│                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  MySQL  │  │  Redis  │  │  Nacos  │    │
│  └─────────┘  └─────────┘  └─────────┘    │
│                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐    │
│  │  User   │  │  Order  │  │ Product │    │
│  │ Service │  │ Service │  │ Service │    │
│  └─────────┘  └─────────┘  └─────────┘    │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │  Prometheus + Grafana + ELK Stack   │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### Kubernetes 集群部署（生产环境）

```
┌───────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                      │
│                                                            │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                    Ingress Layer                     │  │
│  │         (Nginx Ingress / ALB / Cloud LB)            │  │
│  └────────────────────┬────────────────────────────────┘  │
│                       │                                    │
│  ┌────────────────────┼────────────────────────────────┐  │
│  │         API Gateway Service (ClusterIP)             │  │
│  └────────────────────┬────────────────────────────────┘  │
│                       │                                    │
│         ┌─────────────┼─────────────┐                     │
│         │             │             │                     │
│  ┌──────▼──────┐ ┌───▼──────┐ ┌───▼──────┐              │
│  │ User Service│ │Order Svc │ │Product   │              │
│  │  (3 Pods)   │ │(3 Pods)  │ │Svc(3P)   │              │
│  │  + HPA      │ │  + HPA   │ │  + HPA   │              │
│  └──────┬──────┘ └────┬─────┘ └────┬─────┘              │
│         │             │             │                     │
│         └─────────────┼─────────────┘                     │
│                       │                                    │
│  ┌────────────────────┼────────────────────────────────┐  │
│  │              StatefulSet Layer                      │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐            │  │
│  │  │  MySQL  │  │  Redis  │  │  Nacos  │            │  │
│  │  │Cluster  │  │ Cluster │  │ Cluster │            │  │
│  │  └────┬────┘  └────┬────┘  └────┬────┘            │  │
│  │       │            │            │                  │  │
│  │  ┌────▼────────────▼────────────▼────┐            │  │
│  │  │     Persistent Volumes (PV)        │            │  │
│  │  └────────────────────────────────────┘            │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                            │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Monitoring Namespace                    │  │
│  │  Prometheus + Grafana + AlertManager                │  │
│  │  ELK Stack + Zipkin + SkyWalking                    │  │
│  └─────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────┘
```

## 核心设计模式

### 1. 分层架构
- **Controller 层**: 接口定义、参数校验
- **Service 层**: 业务逻辑
- **Repository 层**: 数据访问
- **DTO/VO/Entity**: 数据传输对象

### 2. 微服务拆分原则
- **单一职责**: 每个服务专注一个业务领域
- **高内聚低耦合**: 服务内部功能相关，服务间依赖少
- **数据独立**: 每个服务独立的数据库
- **可独立部署**: 服务可单独发布

### 3. 缓存策略
- **多级缓存**: 本地缓存 + Redis 缓存
- **缓存更新**: Cache Aside / Write Through
- **缓存预热**: 应用启动时加载热点数据
- **缓存失效**: 定时刷新 / 被动失效

### 4. 限流降级
- **限流**: QPS 限流、并发限流
- **熔断**: 快速失败、熔断恢复
- **降级**: 服务降级、数据降级

### 5. 分布式事务
- **本地消息表**: 最终一致性
- **RocketMQ 事务消息**: 分布式事务
- **TCC 模式**: 两阶段提交
- **Seata**: 分布式事务框架

## 安全架构

### 1. 认证授权
- **统一认证**: Gateway 统一鉴权
- **Token 机制**: JWT / Sa-Token
- **权限控制**: RBAC 模型

### 2. 数据安全
- **敏感数据加密**: AES / RSA
- **传输加密**: HTTPS / TLS
- **数据脱敏**: 日志脱敏、展示脱敏

### 3. 网络安全
- **NetworkPolicy**: K8s 网络隔离
- **防火墙**: 云防火墙配置
- **DDoS 防护**: WAF / CDN

## 可用性设计

### 1. 高可用
- **多副本部署**: K8s Deployment replicas >= 3
- **健康检查**: Liveness / Readiness Probe
- **自动恢复**: K8s 自动重启

### 2. 容灾
- **多可用区**: 跨 AZ 部署
- **异地多活**: 跨地域容灾
- **数据备份**: 定时备份、异地备份

### 3. 弹性伸缩
- **HPA**: 基于 CPU/内存自动扩缩容
- **VPA**: 垂直扩缩容
- **Cluster Autoscaler**: 集群节点自动扩缩容

## 性能优化

### 1. 应用层
- **连接池**: 数据库连接池、Redis 连接池
- **异步处理**: 消息队列异步化
- **批量操作**: 批量插入、批量更新

### 2. 数据库
- **索引优化**: 合理创建索引
- **查询优化**: 避免全表扫描
- **读写分离**: 主从复制
- **分库分表**: 水平拆分

### 3. 缓存
- **热点数据缓存**: Redis 缓存
- **本地缓存**: Caffeine / Guava Cache
- **CDN**: 静态资源 CDN

### 4. 网络
- **HTTP/2**: 提升传输效率
- **gRPC**: 服务间通信
- **Keep-Alive**: 连接复用

## 运维体系

### 1. 持续集成/持续部署
- **GitLab CI/CD**: 自动化流水线
- **Jenkins**: 构建部署
- **ArgoCD**: GitOps 部署

### 2. 监控告警
- **指标监控**: Prometheus + Grafana
- **日志监控**: ELK Stack
- **链路追踪**: Zipkin / SkyWalking
- **告警通知**: 钉钉 / 企业微信

### 3. 运维管理
- **配置管理**: Nacos Config
- **发布管理**: 灰度发布、蓝绿部署
- **变更管理**: 变更审批流程
- **应急响应**: 故障处理预案

## 扩展性设计

### 1. 水平扩展
- **无状态服务**: 服务实例可随意增减
- **负载均衡**: LoadBalancer 分发请求
- **分库分表**: 数据库水平拆分

### 2. 垂直扩展
- **资源调整**: 调整 CPU/内存配额
- **数据库升级**: 提升数据库规格

### 3. 业务扩展
- **插件化**: 插件式架构
- **配置化**: 业务规则配置化
- **模块化**: 功能模块化设计

## 总结

本架构设计遵循以下原则：
1. **可维护性**: 代码清晰、文档完善
2. **可扩展性**: 易于水平扩展和功能扩展
3. **高可用性**: 多副本、自动恢复、容灾备份
4. **高性能**: 缓存、异步、连接池等优化
5. **安全性**: 认证授权、数据加密、网络隔离
6. **可观测性**: 完善的监控、日志、链路追踪

通过这套完整的技术架构，能够支撑企业级应用从开发到生产的全生命周期管理。
