image: maven:3.8.6-openjdk-8

stages:
  - build
  - test
  - package
  - docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  NAMESPACE: enterprise

cache:
  paths:
    - .m2/repository/
    - target/

# 编译阶段
build:
  stage: build
  script:
    - mvn clean compile
  only:
    - branches
  tags:
    - docker

# 测试阶段
test:
  stage: test
  script:
    - mvn test
    - mvn jacoco:report
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - '**/target/surefire-reports/TEST-*.xml'
    paths:
      - '**/target/site/jacoco/'
  only:
    - branches
  tags:
    - docker

# 代码质量检查
code-quality:
  stage: test
  script:
    - mvn sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
  only:
    - master
    - develop
  tags:
    - docker
  allow_failure: true

# 打包阶段
package:
  stage: package
  script:
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - '**/target/*.jar'
    expire_in: 1 day
  only:
    - master
    - develop
    - tags
  tags:
    - docker

# Docker 镜像构建
docker-build:
  stage: docker
  image: docker:20.10
  services:
    - docker:20.10-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # 构建用户服务镜像
    - docker build -t $CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA -f enterprise-service-user/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA
    # 如果是 master 分支，同时打 latest 标签
    - |
      if [ "$CI_COMMIT_BRANCH" == "master" ]; then
        docker tag $CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/user-service:latest
        docker push $CI_REGISTRY_IMAGE/user-service:latest
      fi
  only:
    - master
    - develop
    - tags
  tags:
    - docker

# 部署到开发环境
deploy-dev:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context dev-cluster
    - kubectl set image deployment/user-service user-service=$CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA -n $NAMESPACE
    - kubectl rollout status deployment/user-service -n $NAMESPACE
  environment:
    name: development
    url: http://dev.enterprise.com
  only:
    - develop
  tags:
    - kubernetes
  when: manual

# 部署到测试环境
deploy-test:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context test-cluster
    - kubectl set image deployment/user-service user-service=$CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA -n $NAMESPACE
    - kubectl rollout status deployment/user-service -n $NAMESPACE
  environment:
    name: testing
    url: http://test.enterprise.com
  only:
    - master
  tags:
    - kubernetes
  when: manual

# 部署到生产环境
deploy-prod:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context prod-cluster
    # 创建备份
    - kubectl get deployment user-service -n $NAMESPACE -o yaml > backup-user-service-$(date +%Y%m%d-%H%M%S).yaml
    # 部署新版本
    - kubectl set image deployment/user-service user-service=$CI_REGISTRY_IMAGE/user-service:$CI_COMMIT_SHORT_SHA -n $NAMESPACE
    - kubectl rollout status deployment/user-service -n $NAMESPACE --timeout=5m
    # 健康检查
    - |
      for i in {1..30}; do
        if kubectl get pods -n $NAMESPACE -l app=user-service | grep Running; then
          echo "Deployment successful"
          exit 0
        fi
        echo "Waiting for pods to be ready..."
        sleep 10
      done
      echo "Deployment failed"
      kubectl rollout undo deployment/user-service -n $NAMESPACE
      exit 1
  environment:
    name: production
    url: http://www.enterprise.com
  only:
    - tags
  tags:
    - kubernetes
  when: manual

# 回滚生产环境
rollback-prod:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context prod-cluster
    - kubectl rollout undo deployment/user-service -n $NAMESPACE
    - kubectl rollout status deployment/user-service -n $NAMESPACE
  environment:
    name: production
    url: http://www.enterprise.com
  only:
    - tags
  tags:
    - kubernetes
  when: manual
